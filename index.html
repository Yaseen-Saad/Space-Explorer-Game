<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Space Explorer | Interactive 3D Journey</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Space Grotesk', sans-serif;
      color: white;
      background-color: #000;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    #game-ui {
      position: fixed;
      padding: 20px;
      pointer-events: none;
      z-index: 2;
    }

    #fuel-container {
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    #destination-container {
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 5px;
    }

    .screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      text-align: center;
    }

    #start-screen {
      z-index: 100;
    }

    #victory-screen,
    #game-over-screen {
      display: none;
      z-index: 101;
    }

    .screen h1 {
      font-size: 48px;
      margin-bottom: 20px;
      color: #4CAF50;
      text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
      animation: scaleIn 1s ease-out;
    }

    .screen p {
      font-size: 18px;
      margin: 10px 0;
      animation: slideUp 1s ease-out;
    }

    .screen button {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 15px 30px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 25px;
      margin-top: 20px;
      pointer-events: auto;
      transition: transform 0.2s, background 0.2s;
      animation: bounceIn 1s ease-out;
    }

    .screen button:hover {
      background: #45a049;
      transform: scale(1.05);
    }

    #game-tip {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 102;
    }

    .firework {
      position: fixed;
      pointer-events: none;
      z-index: 103;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0);
      }

      to {
        transform: scale(1);
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes bounceIn {
      0% {
        transform: scale(0);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }

    .game-info {
      max-width: 600px;
      margin: 0 auto;
    }

    .controls-section,
    .difficulty-section {
      margin: 20px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    .controls-section h2,
    .difficulty-section h2 {
      color: #4CAF50;
      margin-bottom: 15px;
      font-size: 24px;
    }

    .controls-section ul {
      list-style: none;
      padding: 0;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .controls-section li {
      font-size: 16px;
      padding: 5px 0;
    }

    .difficulty-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .difficulty-btn {
      background: rgba(76, 175, 80, 0.2);
      border: 2px solid #4CAF50;
      color: white;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    .difficulty-btn:hover {
      background: rgba(76, 175, 80, 0.4);
      transform: translateY(-2px);
    }

    .difficulty-btn small {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 5px;
    }

    .difficulty-btn.selected {
      background: #4CAF50;
      border-color: #45a049;
    }

    /* Mobile Controls */
    #mobile-controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      /* Always show for testing */
      z-index: 10;
      pointer-events: auto;
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 15px;
    }

    .control-joystick {
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.2);
      border: 3px solid rgba(76, 175, 80, 0.8);
      border-radius: 50%;
      position: relative;
      margin: 0 20px;
      touch-action: none;
      cursor: pointer;
    }

    .joystick-knob {
      width: 40px;
      height: 40px;
      background: rgba(76, 175, 80, 0.9);
      border: 2px solid #4CAF50;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: none;
      /* Remove transition for better responsiveness */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .control-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .control-btn {
      background: rgba(76, 175, 80, 0.4);
      border: 2px solid #4CAF50;
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      transition: all 0.1s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .control-btn:active {
      background: rgba(76, 175, 80, 0.8);
      transform: scale(0.9);
    }

    .control-btn:hover {
      background: rgba(76, 175, 80, 0.6);
    }

    .controls-layout {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .desktop-controls {
      display: block;
    }

    .mobile-controls-info {
      display: none;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .screen {
        padding: 20px;
        overflow-y: auto;
        height: 100vh;
        height: 100dvh;
        /* Dynamic viewport height for mobile browsers */
        justify-content: flex-start;
        box-sizing: border-box;
      }

      .screen h1 {
        font-size: 32px;
        margin-bottom: 15px;
        margin-top: 20px;
      }

      .screen p {
        font-size: 16px;
        margin: 8px 0;
      }

      .screen button {
        padding: 12px 24px;
        font-size: 16px;
        margin-top: 15px;
        margin-bottom: 20px;
      }

      .game-info {
        max-width: 100%;
        width: 100%;
        margin-bottom: 20px;
      }

      .controls-section,
      .difficulty-section {
        margin: 15px 0;
        padding: 15px;
      }

      .controls-section h2,
      .difficulty-section h2 {
        font-size: 20px;
        margin-bottom: 12px;
      }

      .controls-section ul {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .controls-section li {
        font-size: 14px;
        padding: 3px 0;
      }

      .difficulty-btn {
        padding: 12px;
        font-size: 14px;
      }

      .difficulty-btn small {
        font-size: 12px;
      }

      #game-ui {
        padding: 10px;
        font-size: 14px;
      }

      #fuel-container,
      #destination-container {
        padding: 8px;
        margin-bottom: 8px;
      }

      #game-tip {
        bottom: 160px;
        left: 10px;
        right: 10px;
        transform: none;
        text-align: center;
        font-size: 14px;
        padding: 8px 12px;
      }

      #mobile-controls {
        display: flex;
      }

      .control-joystick {
        width: 100px;
        height: 100px;
        margin: 0 15px;
      }

      .joystick-knob {
        width: 35px;
        height: 35px;
      }

      .control-btn {
        width: 50px;
        height: 50px;
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      .screen h1 {
        font-size: 28px;
      }

      .controls-layout {
        gap: 10px;
      }

      .control-joystick {
        width: 80px;
        height: 80px;
        margin: 0 10px;
      }

      .joystick-knob {
        width: 30px;
        height: 30px;
      }

      .control-btn {
        width: 45px;
        height: 45px;
        font-size: 11px;
      }

      .controls-section,
      .difficulty-section {
        padding: 12px;
      }
    }

    /* Touch-friendly controls display */
    @media (hover: none) and (pointer: coarse) {
      #mobile-controls {
        display: flex;
      }
    }
  </style>
</head>

<body>
  <div id="game-container"></div>

  <!-- Game UI -->
  <div id="game-ui">
    <div id="fuel-container">
      Fuel: <span id="fuel-level">100</span>%
      <div id="low-fuel-warning" style="display: none; color: red;">Low Fuel Warning!</div>
    </div>
    <div id="destination-container">
      <h3>Destinations:</h3>
      <div id="lunar-base">Lunar Base: Not Visited</div>
      <div id="mars-colony">Mars Colony: Not Visited</div>
      <div id="space-station">Space Station: Not Visited</div>
    </div>
    <div id="game-time"></div>
  </div>

  <!-- Start Screen -->
  <div id="start-screen" class="screen">
    <h1>Space Explorer</h1>
    <div class="game-info">
      <div class="controls-section">
        <h2>Controls</h2>
        <ul class="desktop-controls">
          <li>WASD - Move</li>
          <li>E - Move Up</li>
          <li>Shift - Move Down</li>
          <li>Q - Stabilize</li>
          <li>Space - Boost</li>
        </ul>
        <div class="mobile-controls-info" style="display: none;">
          <p>Use the joystick to move and action buttons for up/down movement, boost, and stabilize.</p>
        </div>
      </div>
      <div class="difficulty-section">
        <h2>Select Difficulty</h2>
        <div class="difficulty-options">
          <button id="easy-btn" class="difficulty-btn">
            Easy
            <small>More fuel, slower movement</small>
          </button>
          <button id="medium-btn" class="difficulty-btn selected">
            Medium
            <small>Balanced fuel and speed</small>
          </button>
          <button id="hard-btn" class="difficulty-btn">
            Hard
            <small>Less fuel, faster movement</small>
          </button>
        </div>
      </div>
    </div>
    <button id="start-button">Start Mission</button>
  </div>

  <!-- Victory Screen -->
  <div id="victory-screen" class="screen">
    <h1>Mission Complete!</h1>
    <p>Congratulations! You've visited all destinations!</p>
    <p>Time: <span id="completion-time">0:00</span></p>
    <p>Remaining Fuel: <span id="final-fuel">0</span>%</p>
    <p>Destinations Visited: <span id="destinations-count">0</span>/3</p>
    <button onclick="restartGame()">Play Again</button>
  </div>

  <!-- Game Over Screen -->
  <div id="game-over-screen" class="screen">
    <h1>Mission Failed</h1>
    <p>You ran out of fuel!</p>
    <p>Destinations Visited: <span id="final-destinations">0</span>/3</p>
    <p>Survival Time: <span id="survival-time">0:00</span></p>
    <button onclick="restartGame()">Try Again</button>
  </div>

  <!-- Game Tips -->
  <div id="game-tip"></div>

  <!-- Mobile Controls -->
  <div id="mobile-controls">
    <div class="controls-layout">
      <!-- Movement Joystick -->
      <div class="control-joystick" id="movement-joystick">
        <div class="joystick-knob" id="movement-knob"></div>
      </div>

      <!-- Action Buttons -->
      <div class="control-buttons">
        <div class="control-btn" id="up-btn">UP</div>
        <div style="display: flex; gap: 10px;">
          <div class="control-btn" id="boost-btn">⚡</div>
          <div class="control-btn" id="stabilize-btn">Q</div>
        </div>
        <div class="control-btn" id="down-btn">DN</div>
      </div>
    </div>
  </div>

  <script>
    // Game configuration
    const CONFIG = {
      INITIAL_FUEL: 100,
      DIFFICULTY: {
        easy: {
          movementSpeed: 1,
          fuelConsumption: 0.7
        },
        medium: {
          movementSpeed: 1.2,
          fuelConsumption: 1
        },
        hard: {
          movementSpeed: 1.5,
          fuelConsumption: 1.3
        }
      }
    };

    // Game state
    const gameState = {
      active: false,
      startTime: null,
      fuel: CONFIG.INITIAL_FUEL,
      completionTime: null,
      lowFuelWarning: false,
      destinationsVisited: new Set(),
      velocity: new THREE.Vector3(),
      difficulty: CONFIG.DIFFICULTY.medium // Default to medium difficulty
    };

    // Input state
    const keys = {
      w: false,
      a: false,
      s: false,
      d: false,
      space: false,
      shift: false,
      e: false,
      q: false
    };

    // Mobile controls state
    const mobileControls = {
      joystick: {
        active: false,
        startX: 0,
        startY: 0,
        currentX: 0,
        currentY: 0,
        element: null,
        knob: null
      },
      buttons: {
        up: false,
        down: false,
        boost: false,
        stabilize: false
      }
    };

    function initSimpleMobileControls() {

      // Simple button setup
      const buttonIds = ['up-btn', 'down-btn', 'boost-btn', 'stabilize-btn'];
      const buttonActions = {
        'up-btn': () => {
          keys.e = true;
        },
        'down-btn': () => {
          keys.shift = true;
        },
        'boost-btn': () => {
          keys.space = true;
        },
        'stabilize-btn': () => {
          keys.q = true;
        }
      };

      const resetKeys = () => {
        keys.e = false;
        keys.shift = false;
        keys.space = false;
        keys.q = false;
      };

      buttonIds.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {

          // Clear any existing event listeners
          btn.onclick = null;
          btn.onmousedown = null;
          btn.onmouseup = null;

          // Add simple mouse events
          btn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            buttonActions[id]();
            btn.style.transform = 'scale(0.9)';
            btn.style.background = 'red';
          });

          btn.addEventListener('mouseup', (e) => {
            e.preventDefault();
            resetKeys();
            btn.style.transform = 'scale(1)';
            btn.style.background = '';
          });

          btn.addEventListener('mouseleave', (e) => {
            resetKeys();
            btn.style.transform = 'scale(1)';
            btn.style.background = '';
          });
        }
      });

      // Simple joystick setup
      const joystick = document.getElementById('movement-joystick');
      if (joystick) {

        let isDragging = false;

        joystick.addEventListener('mousedown', (e) => {
          isDragging = true;
          joystick.style.borderColor = 'red';

          const handleMouseMove = (e) => {
            if (!isDragging) return;

            const rect = joystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const deltaX = e.clientX - centerX;
            const deltaY = e.clientY - centerY;

            // Reset movement keys
            keys.w = keys.a = keys.s = keys.d = false;

            // Set keys based on movement
            if (Math.abs(deltaX) > 20) {
              if (deltaX > 0) {
                keys.d = true;
              } else {
                keys.a = true;
              }
            }

            if (Math.abs(deltaY) > 20) {
              if (deltaY > 0) {
                keys.s = true;
              } else {
                keys.w = true;
              }
            }
          };

          const handleMouseUp = () => {
            isDragging = false;
            joystick.style.borderColor = '';
            keys.w = keys.a = keys.s = keys.d = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
          };

          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        });

      }
    }



    // Touch event handlers for mobile controls
    function initMobileControls() {

      (() => {
        // Show mobile controls info in start screen
        const mobileInfo = document.querySelector('.mobile-controls-info');
        const desktopControls = document.querySelector('.desktop-controls');
        if (mobileInfo && desktopControls) {
          mobileInfo.style.display = 'block';
          desktopControls.style.display = 'none';
        }

        // Show mobile controls during gameplay
        const mobileControlsDiv = document.getElementById('mobile-controls');
        if (mobileControlsDiv) {
          mobileControlsDiv.style.display = 'flex';
        }
      })()

      // Always initialize controls for testing (remove this line in production)
      const mobileControlsDiv = document.getElementById('mobile-controls');
      if (mobileControlsDiv) {
        mobileControlsDiv.style.display = 'flex';
      }

      // Joystick setup
      const joystick = document.getElementById('movement-joystick');
      const knob = document.getElementById('movement-knob');

      if (!joystick || !knob) {
        console.error('Mobile controls elements not found:', {
          joystick,
          knob
        });
        return;
      }

      mobileControls.joystick.element = joystick;
      mobileControls.joystick.knob = knob;

      // Joystick touch events
      joystick.addEventListener('touchstart', handleJoystickStart, {
        passive: false
      });
      joystick.addEventListener('touchmove', handleJoystickMove, {
        passive: false
      });
      joystick.addEventListener('touchend', handleJoystickEnd, {
        passive: false
      });

      // Add mouse events as fallback for testing
      joystick.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const fakeTouch = {
          clientX: e.clientX,
          clientY: e.clientY
        };
        const fakeEvent = {
          preventDefault: () => {},
          stopPropagation: () => {},
          touches: [fakeTouch]
        };
        handleJoystickStart(fakeEvent);

        const handleMouseMove = (e) => {
          const fakeTouch = {
            clientX: e.clientX,
            clientY: e.clientY
          };
          const fakeEvent = {
            preventDefault: () => {},
            stopPropagation: () => {},
            touches: [fakeTouch]
          };
          handleJoystickMove(fakeEvent);
        };

        const handleMouseUp = (e) => {
          const fakeEvent = {
            preventDefault: () => {},
            stopPropagation: () => {}
          };
          handleJoystickEnd(fakeEvent);
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      });

      // Button touch events with improved handling
      const buttons = {
        'up-btn': () => {
          mobileControls.buttons.up = true;
          keys.e = true;
        },
        'down-btn': () => {
          mobileControls.buttons.down = true;
          keys.shift = true;
        },
        'boost-btn': () => {
          mobileControls.buttons.boost = true;
          keys.space = true;
        },
        'stabilize-btn': () => {
          mobileControls.buttons.stabilize = true;
          keys.q = true;
        }
      };

      const resetAllButtons = () => {
        mobileControls.buttons.up = false;
        mobileControls.buttons.down = false;
        mobileControls.buttons.boost = false;
        mobileControls.buttons.stabilize = false;
        keys.e = false;
        keys.shift = false;
        keys.space = false;
        keys.q = false;
      };

      Object.keys(buttons).forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          // Touch events
          btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            buttons[id]();
            btn.style.transform = 'scale(0.9)';
            btn.style.background = 'rgba(76, 175, 80, 0.8)';
          }, {
            passive: false
          });

          btn.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            resetAllButtons();
            btn.style.transform = 'scale(1)';
            btn.style.background = '';
          }, {
            passive: false
          });

          // Mouse events (for desktop testing)
          btn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            buttons[id]();
            btn.style.transform = 'scale(0.9)';
            btn.style.background = 'rgba(76, 175, 80, 0.8)';
          });

          btn.addEventListener('mouseup', (e) => {
            e.preventDefault();
            resetAllButtons();
            btn.style.transform = 'scale(1)';
            btn.style.background = '';
          });

          btn.addEventListener('mouseleave', (e) => {
            resetAllButtons();
            btn.style.transform = 'scale(1)';
            btn.style.background = '';
          });
        } else {
          console.warn(`Mobile control button ${id} not found`);
        }
      });
    }

    function handleJoystickStart(e) {
      e.preventDefault();
      e.stopPropagation();


      const touch = e.touches[0];
      const rect = mobileControls.joystick.element.getBoundingClientRect();

      mobileControls.joystick.active = true;
      mobileControls.joystick.startX = rect.left + rect.width / 2;
      mobileControls.joystick.startY = rect.top + rect.height / 2;
      mobileControls.joystick.currentX = touch.clientX;
      mobileControls.joystick.currentY = touch.clientY;
      // Visual feedback
      mobileControls.joystick.element.style.opacity = '0.8';
      mobileControls.joystick.element.style.borderColor = '#4CAF50';

      updateJoystickPosition();
    }

    function handleJoystickMove(e) {
      if (!mobileControls.joystick.active) return;
      e.preventDefault();
      e.stopPropagation();

      const touch = e.touches[0];
      mobileControls.joystick.currentX = touch.clientX;
      mobileControls.joystick.currentY = touch.clientY;

      updateJoystickPosition();
      updateMovementFromJoystick();
    }

    function handleJoystickEnd(e) {
      e.preventDefault();
      e.stopPropagation();


      mobileControls.joystick.active = false;

      // Visual feedback
      mobileControls.joystick.element.style.opacity = '1';
      mobileControls.joystick.element.style.borderColor = 'rgba(76, 175, 80, 0.8)';

      // Reset joystick position
      if (mobileControls.joystick.knob) {
        mobileControls.joystick.knob.style.transform = 'translate(-50%, -50%)';
      }

      // Reset movement keys
      keys.w = false;
      keys.a = false;
      keys.s = false;
      keys.d = false;

    }

    function updateJoystickPosition() {
      if (!mobileControls.joystick.knob) return;

      const deltaX = mobileControls.joystick.currentX - mobileControls.joystick.startX;
      const deltaY = mobileControls.joystick.currentY - mobileControls.joystick.startY;

      const maxDistance = 40; // Maximum distance knob can move from center
      const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

      let x = deltaX;
      let y = deltaY;

      if (distance > maxDistance) {
        const angle = Math.atan2(deltaY, deltaX);
        x = Math.cos(angle) * maxDistance;
        y = Math.sin(angle) * maxDistance;
      }

      mobileControls.joystick.knob.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
    }

    function updateMovementFromJoystick() {
      const deltaX = mobileControls.joystick.currentX - mobileControls.joystick.startX;
      const deltaY = mobileControls.joystick.currentY - mobileControls.joystick.startY;

      const threshold = 15; // Reduced threshold for better sensitivity

      // Reset all movement keys
      const prevKeys = {
        w: keys.w,
        a: keys.a,
        s: keys.s,
        d: keys.d
      };
      keys.w = false;
      keys.a = false;
      keys.s = false;
      keys.d = false;

      // Set movement keys based on joystick position
      if (Math.abs(deltaX) > threshold) {
        if (deltaX > 0) {
          keys.d = true; // Right
        } else {
          keys.a = true; // Left
        }
      }

      if (Math.abs(deltaY) > threshold) {
        if (deltaY > 0) {
          keys.s = true; // Down/Back
        } else {
          keys.w = true; // Up/Forward
        }
      }

      // Log when movement stops
      if ((prevKeys.w || prevKeys.a || prevKeys.s || prevKeys.d) &&
        (!keys.w && !keys.a && !keys.s && !keys.d)) {
      }
    }

    window.initSimpleMobileControls = initSimpleMobileControls;

    // Three.js Variables
    const threeJS = {
      scene: null,
      camera: null,
      renderer: null,
      spaceship: null,
      destinations: []
    };

    // Initialize game
    function init() {
      initScene();
      setupEventListeners();
      animate();
    }

    function setupEventListeners() {
      window.addEventListener('resize', onWindowResize, false);
      window.addEventListener('keydown', onKeyDown, false);
      window.addEventListener('keyup', onKeyUp, false);
      document.getElementById('start-button').addEventListener('click', startGame);

      // Add difficulty selection listeners
      document.getElementById('easy-btn').addEventListener('click', () => setDifficulty('easy'));
      document.getElementById('medium-btn').addEventListener('click', () => setDifficulty('medium'));
      document.getElementById('hard-btn').addEventListener('click', () => setDifficulty('hard'));

      // Initialize mobile controls
      initMobileControls();
    }

    // Make functions globally accessible
    window.startGame = function() {
      if (!gameState.active) {
        document.getElementById('start-screen').style.display = 'none';
        gameState.active = true;
        gameState.startTime = Date.now();
        gameState.fuel = CONFIG.INITIAL_FUEL;

        initSimpleMobileControls()
    
      }
    };

    window.restartGame = function() {
      // Reset game state
      gameState.active = true;
      gameState.startTime = Date.now();
      gameState.fuel = CONFIG.INITIAL_FUEL;
      gameState.destinationsVisited.clear();
      gameState.lowFuelWarning = false;

      // Reset spaceship position and velocity
      threeJS.spaceship.position.set(0, 0, 0);
      gameState.velocity.set(0, 0, 0);

      // Reset camera
      threeJS.camera.position.set(0, 5, 15);
      threeJS.camera.lookAt(threeJS.spaceship.position);

      // Hide all screens
      document.getElementById('victory-screen').style.display = 'none';
      document.getElementById('game-over-screen').style.display = 'none';
      document.getElementById('start-screen').style.display = 'none';

      // Reset fuel display
      document.getElementById('fuel-level').textContent = '100';

      // Reset destinations display
      document.getElementById('destination-container').innerHTML = `
                <h3>Destinations:</h3>
                <div id="lunar-base">Lunar Base: Not Visited</div>
                <div id="mars-colony">Mars Colony: Not Visited</div>
                <div id="space-station">Space Station: Not Visited</div>
            `;

      // Show initial game tip
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
        (navigator.maxTouchPoints && navigator.maxTouchPoints > 1);

      if (isMobile) {
        showGameTip('Use the joystick to move and buttons for up/down movement!', 5000);
      } else {
        showGameTip('Use E to move up and SHIFT to move down!', 5000);
      }
    };

    function onWindowResize() {
      threeJS.camera.aspect = window.innerWidth / window.innerHeight;
      threeJS.camera.updateProjectionMatrix();
      threeJS.renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onKeyDown(e) {
      if (gameState.active) {
        switch (e.key.toLowerCase()) {
          case 'w':
            keys.w = true;
            break;
          case 'a':
            keys.a = true;
            break;
          case 's':
            keys.s = true;
            break;
          case 'd':
            keys.d = true;
            break;
          case ' ':
            keys.space = true;
            e.preventDefault();
            break;
          case 'shift':
            keys.shift = true;
            break;
          case 'e':
            keys.e = true;
            break;
          case 'q':
            keys.q = true;
            break;
        }
      }
    }

    function onKeyUp(e) {
      switch (e.key.toLowerCase()) {
        case 'w':
          keys.w = false;
          break;
        case 'a':
          keys.a = false;
          break;
        case 's':
          keys.s = false;
          break;
        case 'd':
          keys.d = false;
          break;
        case ' ':
          keys.space = false;
          break;
        case 'shift':
          keys.shift = false;
          break;
        case 'e':
          keys.e = false;
          break;
        case 'q':
          keys.q = false;
          break;
      }
    }

    function updateFuel(cost) {
      if (gameState.active && gameState.fuel > 0) {
        gameState.fuel = Math.max(0, gameState.fuel - cost);
        document.getElementById('fuel-level').textContent = Math.round(gameState.fuel) + '%';

        if (gameState.fuel <= 0) {
          gameOver();
        } else if (gameState.fuel < 20 && !gameState.lowFuelWarning) {
          gameState.lowFuelWarning = true;
          showGameTip('Warning: Low Fuel!', 3000);
        }
      }
    }

    function gameOver() {
      gameState.active = false;
      const gameOverScreen = document.getElementById('game-over-screen');
      gameOverScreen.style.display = 'flex';

      document.getElementById('final-destinations').textContent = gameState.destinationsVisited.size;
      document.getElementById('survival-time').textContent = formatTime((Date.now() - gameState.startTime) / 1000);

      gameState.velocity.set(0, 0, 0);
      showGameTip('Out of Fuel - Game Over!', 5000);
    }

    function checkVictory() {
      if (gameState.active && gameState.destinationsVisited.size === threeJS.destinations.length) {
        gameState.active = false;
        gameState.completionTime = (Date.now() - gameState.startTime) / 1000;
        showVictoryScreen();
      }
    }

    function showVictoryScreen() {
      const victoryScreen = document.getElementById('victory-screen');
      victoryScreen.style.display = 'flex';

      const finalTime = (Date.now() - gameState.startTime) / 1000;
      document.getElementById('completion-time').textContent = formatTime(finalTime);
      document.getElementById('final-fuel').textContent = Math.round(gameState.fuel);
      document.getElementById('destinations-count').textContent = gameState.destinationsVisited.size;

      createFireworks();
      gameState.active = false;
    }

    function showGameTip(message, duration = 3000) {
      const tipElement = document.getElementById('game-tip');
      tipElement.textContent = message;
      tipElement.style.display = 'block';
      setTimeout(() => {
        tipElement.style.display = 'none';
      }, duration);
    }

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      // Add leading zero for seconds less than 10
      const formattedSeconds = remainingSeconds < 10 ? `0${remainingSeconds}` : remainingSeconds;
      return `${minutes}:${formattedSeconds}`;
    }

    function updateGameTime() {
      if (gameState.active && gameState.startTime) {
        const currentTime = Date.now();
        const elapsedSeconds = (currentTime - gameState.startTime) / 1000;
        const timeDisplay = formatTime(elapsedSeconds);

        // Update time display if it exists
        const timeElement = document.getElementById('game-time');
        if (!timeElement) {
          // Create time display if it doesn't exist
          const container = document.getElementById('game-ui');
          const timeDiv = document.createElement('div');
          timeDiv.id = 'game-time';
          timeDiv.style.background = 'rgba(0, 0, 0, 0.5)';
          timeDiv.style.padding = '10px';
          timeDiv.style.borderRadius = '5px';
          timeDiv.style.marginBottom = '10px';
          container.insertBefore(timeDiv, container.firstChild);
        }
        document.getElementById('game-time').textContent = `Time: ${timeDisplay}`;
      }
    }

    function checkDestinationReached() {
      threeJS.destinations.forEach(dest => {
        const distance = threeJS.spaceship.position.distanceTo(dest.mesh.position);
        if (distance < 5 && !gameState.destinationsVisited.has(dest.name)) {
          gameState.destinationsVisited.add(dest.name);

          // Update UI for the specific destination
          const destElement = document.getElementById(dest.name.toLowerCase().replace(' ', '-'));
          if (destElement) {
            destElement.textContent = dest.name + ': Visited';
            destElement.style.color = '#4CAF50';
          }

          showGameTip(`Destination reached: ${dest.name}!`, 3000);

          // Check for victory
          if (gameState.destinationsVisited.size === threeJS.destinations.length) {
            showVictoryScreen();
          }
        }
      });
    }

    function updateDestinationInfo() {
      let closestDest = null;
      let minDistance = Infinity;

      threeJS.destinations.forEach(dest => {
        if (!gameState.destinationsVisited.has(dest.name)) {
          const distance = threeJS.spaceship.position.distanceTo(dest.mesh.position);
          if (distance < minDistance) {
            minDistance = distance;
            closestDest = dest;
          }
        }
      });

      if (closestDest) {
        const distance = Math.round(minDistance);
        document.getElementById('destination-container').innerHTML = `
                    <h3>Destinations:</h3>
                    <div id="lunar-base">${threeJS.destinations[0].name}: ${gameState.destinationsVisited.has(threeJS.destinations[0].name) ? '<span style="color: #4CAF50;">Visited</span>' : 'Not Visited'}</div>
                    <div id="mars-colony">${threeJS.destinations[1].name}: ${gameState.destinationsVisited.has(threeJS.destinations[1].name) ? '<span style="color: #4CAF50;">Visited</span>' : 'Not Visited'}</div>
                    <div id="space-station">${threeJS.destinations[2].name}: ${gameState.destinationsVisited.has(threeJS.destinations[2].name) ? '<span style="color: #4CAF50;">Visited</span>' : 'Not Visited'}</div>
                    <div>Nearest: ${closestDest.name} (${distance} units)</div>
                `;
      }
    }

    function animate() {
      requestAnimationFrame(animate);

      if (gameState.active) {
        updateGame();
        updateGameTime();
      }

      threeJS.renderer.render(threeJS.scene, threeJS.camera);
    }

    // Create a spaceship model
    function createSpaceship() {
      const group = new THREE.Group();

      // Main body
      const bodyGeometry = new THREE.ConeGeometry(1, 4, 8);
      const bodyMaterial = new THREE.MeshPhongMaterial({
        color: 0x3366cc,
        shininess: 100
      });
      const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
      body.rotation.x = Math.PI / 2;
      group.add(body);

      // Wings
      const wingGeometry = new THREE.BoxGeometry(3, 0.2, 1);
      const wingMaterial = new THREE.MeshPhongMaterial({
        color: 0x2255aa,
        shininess: 80
      });

      const leftWing = new THREE.Mesh(wingGeometry, wingMaterial);
      leftWing.position.set(-1.5, 0, -1);
      group.add(leftWing);

      const rightWing = new THREE.Mesh(wingGeometry, wingMaterial);
      rightWing.position.set(1.5, 0, -1);
      group.add(rightWing);

      // Cockpit
      const cockpitGeometry = new THREE.SphereGeometry(0.7, 16, 16);
      const cockpitMaterial = new THREE.MeshPhongMaterial({
        color: 0x88ccff,
        shininess: 120,
        transparent: true,
        opacity: 0.7
      });
      const cockpit = new THREE.Mesh(cockpitGeometry, cockpitMaterial);
      cockpit.position.set(0, 0.5, 0);
      group.add(cockpit);

      // Engines
      const engineGeometry = new THREE.CylinderGeometry(0.3, 0.5, 1, 8);
      const engineMaterial = new THREE.MeshPhongMaterial({
        color: 0x444444,
        shininess: 60
      });

      const leftEngine = new THREE.Mesh(engineGeometry, engineMaterial);
      leftEngine.position.set(-1, 0, -2);
      leftEngine.rotation.x = Math.PI / 2;
      group.add(leftEngine);

      const rightEngine = new THREE.Mesh(engineGeometry, engineMaterial);
      rightEngine.position.set(1, 0, -2);
      rightEngine.rotation.x = Math.PI / 2;
      group.add(rightEngine);

      return group;
    }

    // Create destination markers
    function createDestination(type) {
      const group = new THREE.Group();

      // Base platform
      const baseGeometry = new THREE.CylinderGeometry(3, 3, 0.5, 16);
      const baseMaterial = new THREE.MeshPhongMaterial({
        color: type === 'lunar' ? 0x888888 : type === 'mars' ? 0xcc4444 : 0x44cc44,
        shininess: 50
      });
      const base = new THREE.Mesh(baseGeometry, baseMaterial);
      group.add(base);

      // Structure on top
      let structure;
      if (type === 'lunar') {
        // Dome for lunar base
        const domeGeometry = new THREE.SphereGeometry(2, 16, 16, 0, Math.PI * 2, 0, Math.PI / 2);
        const domeMaterial = new THREE.MeshPhongMaterial({
          color: 0xaaaaaa,
          transparent: true,
          opacity: 0.7
        });
        structure = new THREE.Mesh(domeGeometry, domeMaterial);
        structure.position.y = 0.25;
      } else if (type === 'mars') {
        // Buildings for Mars colony
        const buildingGeometry = new THREE.BoxGeometry(1, 2, 1);
        const buildingMaterial = new THREE.MeshPhongMaterial({
          color: 0xdd6666
        });
        structure = new THREE.Group();

        for (let i = 0; i < 3; i++) {
          const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
          building.position.set((i - 1) * 1.2, 1, 0);
          structure.add(building);
        }
      } else {
        // Space station structure
        const stationGeometry = new THREE.TorusGeometry(2, 0.5, 16, 32);
        const stationMaterial = new THREE.MeshPhongMaterial({
          color: 0x66cc66
        });
        structure = new THREE.Mesh(stationGeometry, stationMaterial);
        structure.rotation.x = Math.PI / 2;
      }

      group.add(structure);

      // Add beacon light
      const beaconGeometry = new THREE.SphereGeometry(0.3, 8, 8);
      const beaconMaterial = new THREE.MeshPhongMaterial({
        color: 0xffff00,
        emissive: 0xffff00,
        emissiveIntensity: 0.5
      });
      const beacon = new THREE.Mesh(beaconGeometry, beaconMaterial);
      beacon.position.y = 3;
      group.add(beacon);

      return group;
    }

    // Update game state each frame
    function updateGame() {
      // Update spaceship position based on velocity
      threeJS.spaceship.position.add(gameState.velocity);

      // Apply velocity dampening (space friction/drag)
      gameState.velocity.multiplyScalar(0.99);

      // Handle movement controls
      let isThrusting = false; // Add flag to track if thrusting
      if (keys.w) {
        applyThrust(new THREE.Vector3(0, 0, -0.01));
        isThrusting = true;
      }
      if (keys.s) {
        applyThrust(new THREE.Vector3(0, 0, 0.01));
        isThrusting = true;
      }
      if (keys.a) {
        applyThrust(new THREE.Vector3(-0.01, 0, 0));
        isThrusting = true;
      }
      if (keys.d) {
        applyThrust(new THREE.Vector3(0.01, 0, 0));
        isThrusting = true;
      }
      if (keys.e) {
        applyThrust(new THREE.Vector3(0, 0.01, 0));
        isThrusting = true;
      }
      if (keys.shift) {
        applyThrust(new THREE.Vector3(0, -0.01, 0));
        isThrusting = true;
      }
      if (keys.space) {
        // Boost multiplies current velocity
        gameState.velocity.multiplyScalar(1.05);
        // Extra fuel consumption when boosting
        gameState.fuel -= 0.3 * gameState.difficulty.fuelConsumption;
        isThrusting = true;
      }
      if (keys.q) {
        // Gradually reduce velocity when stabilizing
        gameState.velocity.multiplyScalar(0.9);
        // Small fuel consumption for stabilizing
        gameState.fuel -= 0.05 * gameState.difficulty.fuelConsumption;
        isThrusting = true;
      }

      // Update camera to follow spaceship
      const cameraOffset = new THREE.Vector3(0, 5, 15);
      threeJS.camera.position.copy(threeJS.spaceship.position).add(cameraOffset);
      threeJS.camera.lookAt(threeJS.spaceship.position);

      // Only consume fuel when actively thrusting
      if (isThrusting) {
        gameState.fuel -= 0.1 * gameState.difficulty.fuelConsumption;
      }

      // Update fuel display
      document.getElementById('fuel-level').textContent = Math.max(0, Math.round(gameState.fuel));

      // Show low fuel warning
      if (gameState.fuel < 20 && !document.getElementById('low-fuel-warning').classList.contains('visible')) {
        document.getElementById('low-fuel-warning').classList.add('visible');
      } else if (gameState.fuel >= 20) {
        document.getElementById('low-fuel-warning').classList.remove('visible');
      }

      // Check for game over (no fuel)
      if (gameState.fuel <= 0) {
        gameOver('Out of fuel!');
        return;
      }

      // Check proximity to destinations
      threeJS.destinations.forEach(dest => {
        const distance = threeJS.spaceship.position.distanceTo(dest.mesh.position);
        if (distance < 5 && !gameState.destinationsVisited.has(dest.name)) {
          gameState.destinationsVisited.add(dest.name);

          // Update UI for the specific destination
          const destElement = document.getElementById(dest.name.toLowerCase().replace(' ', '-'));
          if (destElement) {
            destElement.textContent = dest.name + ': Visited';
            destElement.style.color = '#4CAF50';
          }

          showGameTip(`Destination reached: ${dest.name}!`, 3000);

          // Check for victory
          if (gameState.destinationsVisited.size === threeJS.destinations.length) {
            showVictoryScreen();
          }
        }
      });
    }

    // Helper function to apply thrust and handle movement
    function applyThrust(direction) {
      // Scale thrust based on difficulty and multiply by 5 to make movement more noticeable
      const thrustVector = direction.multiplyScalar(gameState.difficulty.movementSpeed * 5);
      gameState.velocity.add(thrustVector);

      // Ensure velocity doesn't exceed maximum speed
      const maxSpeed = 2.0;
      if (gameState.velocity.length() > maxSpeed) {
        gameState.velocity.normalize().multiplyScalar(maxSpeed);
      }
    }

    // Initialize game
    function init() {
      initScene();
      setupEventListeners();
      animate();
    }

    // Initialize Three.js scene
    function initScene() {
      // Create scene
      threeJS.scene = new THREE.Scene();
      threeJS.scene.background = new THREE.Color(0x000000);

      // Create camera
      threeJS.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      threeJS.camera.position.set(0, 5, 15);

      // Create renderer
      threeJS.renderer = new THREE.WebGLRenderer({
        antialias: true
      });
      threeJS.renderer.setSize(window.innerWidth, window.innerHeight);
      threeJS.renderer.setPixelRatio(window.devicePixelRatio);
      document.getElementById('game-container').appendChild(threeJS.renderer.domElement);

      // Add lights
      const ambientLight = new THREE.AmbientLight(0x333333);
      threeJS.scene.add(ambientLight);

      const sunLight = new THREE.DirectionalLight(0xffffff, 1);
      sunLight.position.set(50, 50, 50);
      threeJS.scene.add(sunLight);

      // Add stars
      const starGeometry = new THREE.BufferGeometry();
      const starMaterial = new THREE.PointsMaterial({
        color: 0xffffff,
        size: 0.1
      });

      const starVertices = [];
      for (let i = 0; i < 1000; i++) {
        const x = (Math.random() - 0.5) * 2000;
        const y = (Math.random() - 0.5) * 2000;
        const z = (Math.random() - 0.5) * 2000;
        starVertices.push(x, y, z);
      }

      starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
      const stars = new THREE.Points(starGeometry, starMaterial);
      threeJS.scene.add(stars);

      // Create spaceship
      threeJS.spaceship = createSpaceship();
      threeJS.scene.add(threeJS.spaceship);

      // Create destinations
      threeJS.destinations = [{
          name: 'Lunar Base',
          mesh: createDestination('lunar'),
          position: new THREE.Vector3(30, 0, 30)
        },
        {
          name: 'Mars Colony',
          mesh: createDestination('mars'),
          position: new THREE.Vector3(-30, 40, -30)
        },
        {
          name: 'Space Station',
          mesh: createDestination('station'),
          position: new THREE.Vector3(0, 20, -50)
        }
      ];

      // Position destinations
      threeJS.destinations.forEach(dest => {
        dest.mesh.position.copy(dest.position);
        threeJS.scene.add(dest.mesh);
      });

      // Set initial camera position
      threeJS.camera.lookAt(threeJS.spaceship.position);
    }

    function createFireworks() {
      for (let i = 0; i < 20; i++) {
        setTimeout(() => {
          const firework = document.createElement('div');
          firework.className = 'firework';
          firework.style.left = Math.random() * window.innerWidth + 'px';
          firework.style.top = Math.random() * window.innerHeight + 'px';
          firework.style.width = '5px';
          firework.style.height = '5px';
          firework.style.borderRadius = '50%';
          firework.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
          firework.style.boxShadow = '0 0 20px currentColor';
          document.body.appendChild(firework);

          // Animate
          const angle = Math.random() * Math.PI * 2;
          const velocity = 10 + Math.random() * 10;
          const dx = Math.cos(angle) * velocity;
          const dy = Math.sin(angle) * velocity;

          let x = parseInt(firework.style.left);
          let y = parseInt(firework.style.top);
          let opacity = 1;

          const animate = () => {
            x += dx;
            y += dy;
            opacity -= 0.02;

            firework.style.left = x + 'px';
            firework.style.top = y + 'px';
            firework.style.opacity = opacity;

            if (opacity > 0) {
              requestAnimationFrame(animate);
            } else {
              firework.remove();
            }
          };

          animate();
        }, i * 200);
      }
    }

    // Initialize event listeners
    function setupEventListeners() {
      // Window events
      window.addEventListener('resize', onWindowResize, false);
      window.addEventListener('keydown', onKeyDown, false);
      window.addEventListener('keyup', onKeyUp, false);

      // Game control buttons
      const startButton = document.getElementById('start-button');
      if (startButton) {
        startButton.addEventListener('click', startGame);
      }

      // Difficulty buttons
      const easyBtn = document.getElementById('easy-btn');
      const mediumBtn = document.getElementById('medium-btn');
      const hardBtn = document.getElementById('hard-btn');

      if (easyBtn && mediumBtn && hardBtn) {
        easyBtn.addEventListener('click', () => setDifficulty('easy'));
        mediumBtn.addEventListener('click', () => setDifficulty('medium'));
        hardBtn.addEventListener('click', () => setDifficulty('hard'));
      }

      // Set initial difficulty
      setDifficulty('medium');
    }

    // Initialize the game when the DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    function setDifficulty(level) {
      gameState.difficulty = CONFIG.DIFFICULTY[level];

      // Update UI to show selected difficulty
      ['easy-btn', 'medium-btn', 'hard-btn'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.style.background = id === `${level}-btn` ? 'rgba(76, 175, 80, 0.4)' : 'rgba(76, 175, 80, 0.2)';
        }
      });

      // Show feedback
      showGameTip(`Difficulty set to ${level.charAt(0).toUpperCase() + level.slice(1)}`, 2000);
    }
  </script>
</body>

</html>